name: Build flatpak

on:
  push:
    tags:
      - "*"

  workflow_dispatch:

jobs:
  build:
    name: Build bundle
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/andyholmes/flatter/kde:5.15-22.08
      options: --privileged

    strategy:
      matrix:
        arch: [x86_64]
      fail-fast: false
      # Only one job at a time can use the shared repository cache
      max-parallel: 1

    steps:
      # Checkout a repository with Flatpak manifests
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: realthunder/org.freecadweb.FreeCAD.Link
          submodules: true

      - name: Setup build
        run: |
          tag=${{ github.ref_name }}
          name=org.freecadweb.FreeCAD.Link
          sed -i 's|branch: LinkMerge|tag: ${{github.ref_name}}|' $name.yaml
          url=https://github.com/realthunder/$name.BaseApp/releases/download/20230430/$name
          if ! which wget; then yum install wget -y; fi
          wget -q $url.BaseApp3.flatpak
          flatpak install -y $name.BaseApp3.flatpak

      - name: Build
        id: flatpak
        uses: andyholmes/flatter@main
        with:
          files: |
            org.freecadweb.FreeCAD.Link.yaml
          arch: ${{ matrix.arch }}
          upload-bundles: true
          cache-key: FreeCAD-Link
          flatpak-builder-args: |
            --install-deps-from=flathub

  # See "Github Pages" below
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Prepare assets
        run: |
          set -x
          name=org.freecadweb.FreeCAD.Link.BaseApp
          mv $name*/*.flatpak .
          name=`echo *.flatpak`
          echo "RELEASE_ASSETS=$name" >> $GITHUB_ENV
          tag=${{ github.ref_name }}
          case $tag in
          *tip)
              echo "RELEASE_NAME=Tip" >> $GITHUB_ENV
              echo "IS_PRERELEASE=true" >> $GITHUB_ENV
              branding=../conda/branding/asm3-daily
              ;;
          *edge)
              echo "RELEASE_NAME=Edge" >> $GITHUB_ENV
              echo "IS_PRERELEASE=true" >> $GITHUB_ENV
              release=Edge
              branding=../conda/branding/asm3-daily
              ;;
          *stable)
              echo "RELEASE_NAME=$tag" >> $GITHUB_ENV
              echo "IS_PRERELEASE=false" >> $GITHUB_ENV
              ;;
          *)
              echo "Invalid tag"
              exit 1
          esac

      - name: Delete old release assets
        uses: realthunder/delete-release-assets@v1
        with:
          fail-if-no-assets: false
          fail-if-no-release: false
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.RELEASE_NAME }}
          # repository: realthunder/FreeCAD
          assets: |
              ${{ env.RELEASE_ASSETS }}

      - name: Upload release
        if: startsWith(github.ref, 'refs/tags/')
        uses: realthunder/action-gh-release@v1
        with:
          files: ${{ env.RELEASE_ASSETS }}
          name: ${{ env.RELEASE_NAME }}
          prerelease: ${{ env.IS_PRERELEASE }}
          tag_name: ${{ env.RELEASE_NAME }}
          token: ${{ secrets.GITHUB_TOKEN }}
